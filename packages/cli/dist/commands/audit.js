"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.audit = audit;
const child_process_1 = require("child_process");
const canon_1 = require("@gallop/canon");
// Colors for terminal output
const c = {
    reset: '\x1b[0m',
    bold: '\x1b[1m',
    dim: '\x1b[2m',
    red: '\x1b[31m',
    green: '\x1b[32m',
    yellow: '\x1b[33m',
    blue: '\x1b[34m',
    cyan: '\x1b[36m',
};
// Build rule-to-pattern mapping from Canon schema (single source of truth)
const ruleToPattern = {};
for (const pattern of canon_1.patterns) {
    if (pattern.rule) {
        ruleToPattern[pattern.rule] = pattern.id;
    }
}
function parseCanonFromMessage(message) {
    const match = message.match(/\[Canon (\d{3})\]/);
    return match ? match[1] : null;
}
function extractViolations(eslintOutput) {
    const violations = [];
    const lines = eslintOutput.split('\n');
    let currentFile = '';
    for (const line of lines) {
        // File path line (starts with /)
        if (line.startsWith('/') && !line.includes(':')) {
            currentFile = line.trim();
            continue;
        }
        // Violation line (starts with spaces, has line:col pattern)
        const match = line.match(/^\s+(\d+):(\d+)\s+(warning|error)\s+(.+?)\s{2,}([\w/-]+)$/);
        if (match && currentFile) {
            const [, lineNum, column, , message, ruleId] = match;
            const canonPattern = ruleToPattern[ruleId] || parseCanonFromMessage(message);
            const pattern = canonPattern ? (0, canon_1.getPattern)(canonPattern) : null;
            violations.push({
                file: currentFile,
                line: parseInt(lineNum, 10),
                column: parseInt(column, 10),
                message: message.trim(),
                ruleId,
                canonPattern,
                patternTitle: pattern?.title || null,
            });
        }
    }
    return violations;
}
function countByPattern(violations) {
    const counts = {};
    for (const v of violations) {
        const key = v.canonPattern || 'other';
        counts[key] = (counts[key] || 0) + 1;
    }
    return counts;
}
function groupByFile(violations) {
    const groups = new Map();
    for (const v of violations) {
        const existing = groups.get(v.file) || [];
        existing.push(v);
        groups.set(v.file, existing);
    }
    return groups;
}
function printReport(result, options) {
    if (options.json) {
        console.log(JSON.stringify(result, null, 2));
        return;
    }
    // Header
    console.log('');
    console.log(`${c.bold}╔════════════════════════════════════════════════════════════╗${c.reset}`);
    console.log(`${c.bold}║${c.reset}           ${c.cyan}Gallop Canon${c.reset} ${c.dim}v${result.version}${c.reset} ${c.bold}Compliance Report${c.reset}           ${c.bold}║${c.reset}`);
    console.log(`${c.bold}╚════════════════════════════════════════════════════════════╝${c.reset}`);
    console.log('');
    if (result.violations.length === 0) {
        console.log(`  ${c.green}✓${c.reset} ${c.bold}All files pass Canon compliance checks${c.reset}`);
        console.log(`  ${c.dim}Path: ${result.path}${c.reset}`);
        console.log('');
        return;
    }
    // Summary
    const filesWithViolations = new Set(result.violations.map(v => v.file)).size;
    console.log(`  ${c.red}✗${c.reset} ${c.bold}${result.violations.length} violation${result.violations.length === 1 ? '' : 's'}${c.reset} in ${filesWithViolations} file${filesWithViolations === 1 ? '' : 's'}`);
    console.log(`  ${c.dim}Path: ${result.path}${c.reset}`);
    console.log('');
    // Violations by pattern
    console.log(`${c.bold}  Violations by Pattern:${c.reset}`);
    for (const [patternId, count] of Object.entries(result.summary.byPattern).sort()) {
        const pattern = (0, canon_1.getPattern)(patternId);
        const title = pattern?.title || 'Other';
        console.log(`    ${c.yellow}${patternId}${c.reset} ${title}: ${c.bold}${count}${c.reset}`);
    }
    console.log('');
    // Detailed violations by file
    console.log(`${c.bold}  Details:${c.reset}`);
    console.log('');
    const byFile = groupByFile(result.violations);
    for (const [file, violations] of byFile) {
        // Shorten file path for display
        const shortPath = file.replace(process.cwd() + '/', '');
        console.log(`  ${c.cyan}${shortPath}${c.reset}`);
        for (const v of violations) {
            const patternLabel = v.canonPattern
                ? `${c.yellow}[${v.canonPattern}]${c.reset}`
                : `${c.dim}[---]${c.reset}`;
            const location = `${c.dim}${v.line}:${v.column}${c.reset}`;
            // Clean up message (remove [Canon XXX] prefix since we show it separately)
            const cleanMessage = v.message.replace(/\[Canon \d{3}\]\s*/, '');
            console.log(`    ${location} ${patternLabel} ${cleanMessage}`);
        }
        console.log('');
    }
    // Footer
    console.log(`${c.dim}  ─────────────────────────────────────────────────────────${c.reset}`);
    console.log(`  ${c.dim}Fix violations manually following the Canon patterns${c.reset}`);
    console.log('');
}
async function audit(path, options) {
    return new Promise((resolve, reject) => {
        const args = [
            'eslint',
            path,
            '--format', 'stylish',
        ];
        if (options.fix) {
            args.push('--fix');
        }
        const eslint = (0, child_process_1.spawn)('npx', args, {
            cwd: process.cwd(),
            stdio: ['inherit', 'pipe', 'pipe'],
            shell: true,
        });
        let stdout = '';
        let stderr = '';
        eslint.stdout?.on('data', (data) => {
            stdout += data.toString();
        });
        eslint.stderr?.on('data', (data) => {
            stderr += data.toString();
        });
        eslint.on('close', (code) => {
            const violations = extractViolations(stdout);
            const result = {
                version: canon_1.version,
                timestamp: new Date().toISOString(),
                path,
                totalFiles: 0, // ESLint stylish format doesn't give us this easily
                violations,
                summary: {
                    total: violations.length,
                    byPattern: countByPattern(violations),
                },
            };
            printReport(result, options);
            if (options.strict && violations.length > 0) {
                process.exit(1);
            }
            resolve();
        });
        eslint.on('error', (error) => {
            reject(error);
        });
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXVkaXQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvY29tbWFuZHMvYXVkaXQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUErS0Esc0JBeURDO0FBeE9ELGlEQUFxQztBQUNyQyx5Q0FBNkQ7QUE4QjdELDZCQUE2QjtBQUM3QixNQUFNLENBQUMsR0FBRztJQUNSLEtBQUssRUFBRSxTQUFTO0lBQ2hCLElBQUksRUFBRSxTQUFTO0lBQ2YsR0FBRyxFQUFFLFNBQVM7SUFDZCxHQUFHLEVBQUUsVUFBVTtJQUNmLEtBQUssRUFBRSxVQUFVO0lBQ2pCLE1BQU0sRUFBRSxVQUFVO0lBQ2xCLElBQUksRUFBRSxVQUFVO0lBQ2hCLElBQUksRUFBRSxVQUFVO0NBQ2pCLENBQUE7QUFFRCwyRUFBMkU7QUFDM0UsTUFBTSxhQUFhLEdBQTJCLEVBQUUsQ0FBQTtBQUNoRCxLQUFLLE1BQU0sT0FBTyxJQUFJLGdCQUFRLEVBQUUsQ0FBQztJQUMvQixJQUFJLE9BQU8sQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUNqQixhQUFhLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxHQUFHLE9BQU8sQ0FBQyxFQUFFLENBQUE7SUFDMUMsQ0FBQztBQUNILENBQUM7QUFFRCxTQUFTLHFCQUFxQixDQUFDLE9BQWU7SUFDNUMsTUFBTSxLQUFLLEdBQUcsT0FBTyxDQUFDLEtBQUssQ0FBQyxtQkFBbUIsQ0FBQyxDQUFBO0lBQ2hELE9BQU8sS0FBSyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQTtBQUNoQyxDQUFDO0FBRUQsU0FBUyxpQkFBaUIsQ0FBQyxZQUFvQjtJQUM3QyxNQUFNLFVBQVUsR0FBZ0IsRUFBRSxDQUFBO0lBQ2xDLE1BQU0sS0FBSyxHQUFHLFlBQVksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUE7SUFFdEMsSUFBSSxXQUFXLEdBQUcsRUFBRSxDQUFBO0lBRXBCLEtBQUssTUFBTSxJQUFJLElBQUksS0FBSyxFQUFFLENBQUM7UUFDekIsaUNBQWlDO1FBQ2pDLElBQUksSUFBSSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQztZQUNoRCxXQUFXLEdBQUcsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFBO1lBQ3pCLFNBQVE7UUFDVixDQUFDO1FBRUQsNERBQTREO1FBQzVELE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsMkRBQTJELENBQUMsQ0FBQTtRQUNyRixJQUFJLEtBQUssSUFBSSxXQUFXLEVBQUUsQ0FBQztZQUN6QixNQUFNLENBQUMsRUFBRSxPQUFPLEVBQUUsTUFBTSxFQUFFLEFBQUQsRUFBRyxPQUFPLEVBQUUsTUFBTSxDQUFDLEdBQUcsS0FBSyxDQUFBO1lBQ3BELE1BQU0sWUFBWSxHQUFHLGFBQWEsQ0FBQyxNQUFNLENBQUMsSUFBSSxxQkFBcUIsQ0FBQyxPQUFPLENBQUMsQ0FBQTtZQUM1RSxNQUFNLE9BQU8sR0FBRyxZQUFZLENBQUMsQ0FBQyxDQUFDLElBQUEsa0JBQVUsRUFBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFBO1lBRTlELFVBQVUsQ0FBQyxJQUFJLENBQUM7Z0JBQ2QsSUFBSSxFQUFFLFdBQVc7Z0JBQ2pCLElBQUksRUFBRSxRQUFRLENBQUMsT0FBTyxFQUFFLEVBQUUsQ0FBQztnQkFDM0IsTUFBTSxFQUFFLFFBQVEsQ0FBQyxNQUFNLEVBQUUsRUFBRSxDQUFDO2dCQUM1QixPQUFPLEVBQUUsT0FBTyxDQUFDLElBQUksRUFBRTtnQkFDdkIsTUFBTTtnQkFDTixZQUFZO2dCQUNaLFlBQVksRUFBRSxPQUFPLEVBQUUsS0FBSyxJQUFJLElBQUk7YUFDckMsQ0FBQyxDQUFBO1FBQ0osQ0FBQztJQUNILENBQUM7SUFFRCxPQUFPLFVBQVUsQ0FBQTtBQUNuQixDQUFDO0FBRUQsU0FBUyxjQUFjLENBQUMsVUFBdUI7SUFDN0MsTUFBTSxNQUFNLEdBQTJCLEVBQUUsQ0FBQTtJQUN6QyxLQUFLLE1BQU0sQ0FBQyxJQUFJLFVBQVUsRUFBRSxDQUFDO1FBQzNCLE1BQU0sR0FBRyxHQUFHLENBQUMsQ0FBQyxZQUFZLElBQUksT0FBTyxDQUFBO1FBQ3JDLE1BQU0sQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUE7SUFDdEMsQ0FBQztJQUNELE9BQU8sTUFBTSxDQUFBO0FBQ2YsQ0FBQztBQUVELFNBQVMsV0FBVyxDQUFDLFVBQXVCO0lBQzFDLE1BQU0sTUFBTSxHQUFHLElBQUksR0FBRyxFQUF1QixDQUFBO0lBQzdDLEtBQUssTUFBTSxDQUFDLElBQUksVUFBVSxFQUFFLENBQUM7UUFDM0IsTUFBTSxRQUFRLEdBQUcsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFBO1FBQ3pDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUE7UUFDaEIsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUFFLFFBQVEsQ0FBQyxDQUFBO0lBQzlCLENBQUM7SUFDRCxPQUFPLE1BQU0sQ0FBQTtBQUNmLENBQUM7QUFFRCxTQUFTLFdBQVcsQ0FBQyxNQUFtQixFQUFFLE9BQXFCO0lBQzdELElBQUksT0FBTyxDQUFDLElBQUksRUFBRSxDQUFDO1FBQ2pCLE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUE7UUFDNUMsT0FBTTtJQUNSLENBQUM7SUFFRCxTQUFTO0lBQ1QsT0FBTyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQTtJQUNmLE9BQU8sQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxpRUFBaUUsQ0FBQyxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUE7SUFDaEcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLElBQUksQ0FBQyxDQUFDLEtBQUssY0FBYyxDQUFDLENBQUMsSUFBSSxlQUFlLENBQUMsQ0FBQyxLQUFLLElBQUksQ0FBQyxDQUFDLEdBQUcsSUFBSSxNQUFNLENBQUMsT0FBTyxHQUFHLENBQUMsQ0FBQyxLQUFLLElBQUksQ0FBQyxDQUFDLElBQUksb0JBQW9CLENBQUMsQ0FBQyxLQUFLLGNBQWMsQ0FBQyxDQUFDLElBQUksSUFBSSxDQUFDLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQTtJQUN0TCxPQUFPLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksaUVBQWlFLENBQUMsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFBO0lBQ2hHLE9BQU8sQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLENBQUE7SUFFZixJQUFJLE1BQU0sQ0FBQyxVQUFVLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRSxDQUFDO1FBQ25DLE9BQU8sQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUMsS0FBSyxJQUFJLENBQUMsQ0FBQyxLQUFLLElBQUksQ0FBQyxDQUFDLElBQUkseUNBQXlDLENBQUMsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFBO1FBQ2hHLE9BQU8sQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUMsR0FBRyxTQUFTLE1BQU0sQ0FBQyxJQUFJLEdBQUcsQ0FBQyxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUE7UUFDdkQsT0FBTyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQTtRQUNmLE9BQU07SUFDUixDQUFDO0lBRUQsVUFBVTtJQUNWLE1BQU0sbUJBQW1CLEdBQUcsSUFBSSxHQUFHLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUE7SUFDNUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxDQUFDLEtBQUssSUFBSSxDQUFDLENBQUMsSUFBSSxHQUFHLE1BQU0sQ0FBQyxVQUFVLENBQUMsTUFBTSxhQUFhLE1BQU0sQ0FBQyxVQUFVLENBQUMsTUFBTSxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxDQUFDLEtBQUssT0FBTyxtQkFBbUIsUUFBUSxtQkFBbUIsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQTtJQUMvTSxPQUFPLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDLEdBQUcsU0FBUyxNQUFNLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFBO0lBQ3ZELE9BQU8sQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLENBQUE7SUFFZix3QkFBd0I7SUFDeEIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLDJCQUEyQixDQUFDLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQTtJQUMxRCxLQUFLLE1BQU0sQ0FBQyxTQUFTLEVBQUUsS0FBSyxDQUFDLElBQUksTUFBTSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDLElBQUksRUFBRSxFQUFFLENBQUM7UUFDakYsTUFBTSxPQUFPLEdBQUcsSUFBQSxrQkFBVSxFQUFDLFNBQVMsQ0FBQyxDQUFBO1FBQ3JDLE1BQU0sS0FBSyxHQUFHLE9BQU8sRUFBRSxLQUFLLElBQUksT0FBTyxDQUFBO1FBQ3ZDLE9BQU8sQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUMsTUFBTSxHQUFHLFNBQVMsR0FBRyxDQUFDLENBQUMsS0FBSyxJQUFJLEtBQUssS0FBSyxDQUFDLENBQUMsSUFBSSxHQUFHLEtBQUssR0FBRyxDQUFDLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQTtJQUM1RixDQUFDO0lBQ0QsT0FBTyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQTtJQUVmLDhCQUE4QjtJQUM5QixPQUFPLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksYUFBYSxDQUFDLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQTtJQUM1QyxPQUFPLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFBO0lBRWYsTUFBTSxNQUFNLEdBQUcsV0FBVyxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsQ0FBQTtJQUM3QyxLQUFLLE1BQU0sQ0FBQyxJQUFJLEVBQUUsVUFBVSxDQUFDLElBQUksTUFBTSxFQUFFLENBQUM7UUFDeEMsZ0NBQWdDO1FBQ2hDLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLEdBQUcsRUFBRSxHQUFHLEdBQUcsRUFBRSxFQUFFLENBQUMsQ0FBQTtRQUN2RCxPQUFPLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDLElBQUksR0FBRyxTQUFTLEdBQUcsQ0FBQyxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUE7UUFFaEQsS0FBSyxNQUFNLENBQUMsSUFBSSxVQUFVLEVBQUUsQ0FBQztZQUMzQixNQUFNLFlBQVksR0FBRyxDQUFDLENBQUMsWUFBWTtnQkFDakMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sSUFBSSxDQUFDLENBQUMsWUFBWSxJQUFJLENBQUMsQ0FBQyxLQUFLLEVBQUU7Z0JBQzVDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLFFBQVEsQ0FBQyxDQUFDLEtBQUssRUFBRSxDQUFBO1lBQzdCLE1BQU0sUUFBUSxHQUFHLEdBQUcsQ0FBQyxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUMsSUFBSSxJQUFJLENBQUMsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLEtBQUssRUFBRSxDQUFBO1lBRTFELDJFQUEyRTtZQUMzRSxNQUFNLFlBQVksR0FBRyxDQUFDLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxvQkFBb0IsRUFBRSxFQUFFLENBQUMsQ0FBQTtZQUVoRSxPQUFPLENBQUMsR0FBRyxDQUFDLE9BQU8sUUFBUSxJQUFJLFlBQVksSUFBSSxZQUFZLEVBQUUsQ0FBQyxDQUFBO1FBQ2hFLENBQUM7UUFDRCxPQUFPLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFBO0lBQ2pCLENBQUM7SUFFRCxTQUFTO0lBQ1QsT0FBTyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLDhEQUE4RCxDQUFDLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQTtJQUM1RixPQUFPLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDLEdBQUcsdURBQXVELENBQUMsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFBO0lBQ3ZGLE9BQU8sQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLENBQUE7QUFDakIsQ0FBQztBQUVNLEtBQUssVUFBVSxLQUFLLENBQUMsSUFBWSxFQUFFLE9BQXFCO0lBQzdELE9BQU8sSUFBSSxPQUFPLENBQUMsQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLEVBQUU7UUFDckMsTUFBTSxJQUFJLEdBQUc7WUFDWCxRQUFRO1lBQ1IsSUFBSTtZQUNKLFVBQVUsRUFBRSxTQUFTO1NBQ3RCLENBQUE7UUFFRCxJQUFJLE9BQU8sQ0FBQyxHQUFHLEVBQUUsQ0FBQztZQUNoQixJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFBO1FBQ3BCLENBQUM7UUFFRCxNQUFNLE1BQU0sR0FBRyxJQUFBLHFCQUFLLEVBQUMsS0FBSyxFQUFFLElBQUksRUFBRTtZQUNoQyxHQUFHLEVBQUUsT0FBTyxDQUFDLEdBQUcsRUFBRTtZQUNsQixLQUFLLEVBQUUsQ0FBQyxTQUFTLEVBQUUsTUFBTSxFQUFFLE1BQU0sQ0FBQztZQUNsQyxLQUFLLEVBQUUsSUFBSTtTQUNaLENBQUMsQ0FBQTtRQUVGLElBQUksTUFBTSxHQUFHLEVBQUUsQ0FBQTtRQUNmLElBQUksTUFBTSxHQUFHLEVBQUUsQ0FBQTtRQUVmLE1BQU0sQ0FBQyxNQUFNLEVBQUUsRUFBRSxDQUFDLE1BQU0sRUFBRSxDQUFDLElBQUksRUFBRSxFQUFFO1lBQ2pDLE1BQU0sSUFBSSxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUE7UUFDM0IsQ0FBQyxDQUFDLENBQUE7UUFFRixNQUFNLENBQUMsTUFBTSxFQUFFLEVBQUUsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxJQUFJLEVBQUUsRUFBRTtZQUNqQyxNQUFNLElBQUksSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFBO1FBQzNCLENBQUMsQ0FBQyxDQUFBO1FBRUYsTUFBTSxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxJQUFJLEVBQUUsRUFBRTtZQUMxQixNQUFNLFVBQVUsR0FBRyxpQkFBaUIsQ0FBQyxNQUFNLENBQUMsQ0FBQTtZQUU1QyxNQUFNLE1BQU0sR0FBZ0I7Z0JBQzFCLE9BQU8sRUFBUCxlQUFPO2dCQUNQLFNBQVMsRUFBRSxJQUFJLElBQUksRUFBRSxDQUFDLFdBQVcsRUFBRTtnQkFDbkMsSUFBSTtnQkFDSixVQUFVLEVBQUUsQ0FBQyxFQUFFLG9EQUFvRDtnQkFDbkUsVUFBVTtnQkFDVixPQUFPLEVBQUU7b0JBQ1AsS0FBSyxFQUFFLFVBQVUsQ0FBQyxNQUFNO29CQUN4QixTQUFTLEVBQUUsY0FBYyxDQUFDLFVBQVUsQ0FBQztpQkFDdEM7YUFDRixDQUFBO1lBRUQsV0FBVyxDQUFDLE1BQU0sRUFBRSxPQUFPLENBQUMsQ0FBQTtZQUU1QixJQUFJLE9BQU8sQ0FBQyxNQUFNLElBQUksVUFBVSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUUsQ0FBQztnQkFDNUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQTtZQUNqQixDQUFDO1lBRUQsT0FBTyxFQUFFLENBQUE7UUFDWCxDQUFDLENBQUMsQ0FBQTtRQUVGLE1BQU0sQ0FBQyxFQUFFLENBQUMsT0FBTyxFQUFFLENBQUMsS0FBSyxFQUFFLEVBQUU7WUFDM0IsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFBO1FBQ2YsQ0FBQyxDQUFDLENBQUE7SUFDSixDQUFDLENBQUMsQ0FBQTtBQUNKLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBzcGF3biB9IGZyb20gJ2NoaWxkX3Byb2Nlc3MnXG5pbXBvcnQgeyB2ZXJzaW9uLCBwYXR0ZXJucywgZ2V0UGF0dGVybiB9IGZyb20gJ0BnYWxsb3AvY2Fub24nXG5cbmludGVyZmFjZSBBdWRpdE9wdGlvbnMge1xuICBzdHJpY3Q6IGJvb2xlYW5cbiAganNvbjogYm9vbGVhblxuICBmaXg6IGJvb2xlYW5cbn1cblxuaW50ZXJmYWNlIFZpb2xhdGlvbiB7XG4gIGZpbGU6IHN0cmluZ1xuICBsaW5lOiBudW1iZXJcbiAgY29sdW1uOiBudW1iZXJcbiAgbWVzc2FnZTogc3RyaW5nXG4gIHJ1bGVJZDogc3RyaW5nXG4gIGNhbm9uUGF0dGVybjogc3RyaW5nIHwgbnVsbFxuICBwYXR0ZXJuVGl0bGU6IHN0cmluZyB8IG51bGxcbn1cblxuaW50ZXJmYWNlIEF1ZGl0UmVzdWx0IHtcbiAgdmVyc2lvbjogc3RyaW5nXG4gIHRpbWVzdGFtcDogc3RyaW5nXG4gIHBhdGg6IHN0cmluZ1xuICB0b3RhbEZpbGVzOiBudW1iZXJcbiAgdmlvbGF0aW9uczogVmlvbGF0aW9uW11cbiAgc3VtbWFyeToge1xuICAgIHRvdGFsOiBudW1iZXJcbiAgICBieVBhdHRlcm46IFJlY29yZDxzdHJpbmcsIG51bWJlcj5cbiAgfVxufVxuXG4vLyBDb2xvcnMgZm9yIHRlcm1pbmFsIG91dHB1dFxuY29uc3QgYyA9IHtcbiAgcmVzZXQ6ICdcXHgxYlswbScsXG4gIGJvbGQ6ICdcXHgxYlsxbScsXG4gIGRpbTogJ1xceDFiWzJtJyxcbiAgcmVkOiAnXFx4MWJbMzFtJyxcbiAgZ3JlZW46ICdcXHgxYlszMm0nLFxuICB5ZWxsb3c6ICdcXHgxYlszM20nLFxuICBibHVlOiAnXFx4MWJbMzRtJyxcbiAgY3lhbjogJ1xceDFiWzM2bScsXG59XG5cbi8vIEJ1aWxkIHJ1bGUtdG8tcGF0dGVybiBtYXBwaW5nIGZyb20gQ2Fub24gc2NoZW1hIChzaW5nbGUgc291cmNlIG9mIHRydXRoKVxuY29uc3QgcnVsZVRvUGF0dGVybjogUmVjb3JkPHN0cmluZywgc3RyaW5nPiA9IHt9XG5mb3IgKGNvbnN0IHBhdHRlcm4gb2YgcGF0dGVybnMpIHtcbiAgaWYgKHBhdHRlcm4ucnVsZSkge1xuICAgIHJ1bGVUb1BhdHRlcm5bcGF0dGVybi5ydWxlXSA9IHBhdHRlcm4uaWRcbiAgfVxufVxuXG5mdW5jdGlvbiBwYXJzZUNhbm9uRnJvbU1lc3NhZ2UobWVzc2FnZTogc3RyaW5nKTogc3RyaW5nIHwgbnVsbCB7XG4gIGNvbnN0IG1hdGNoID0gbWVzc2FnZS5tYXRjaCgvXFxbQ2Fub24gKFxcZHszfSlcXF0vKVxuICByZXR1cm4gbWF0Y2ggPyBtYXRjaFsxXSA6IG51bGxcbn1cblxuZnVuY3Rpb24gZXh0cmFjdFZpb2xhdGlvbnMoZXNsaW50T3V0cHV0OiBzdHJpbmcpOiBWaW9sYXRpb25bXSB7XG4gIGNvbnN0IHZpb2xhdGlvbnM6IFZpb2xhdGlvbltdID0gW11cbiAgY29uc3QgbGluZXMgPSBlc2xpbnRPdXRwdXQuc3BsaXQoJ1xcbicpXG4gIFxuICBsZXQgY3VycmVudEZpbGUgPSAnJ1xuICBcbiAgZm9yIChjb25zdCBsaW5lIG9mIGxpbmVzKSB7XG4gICAgLy8gRmlsZSBwYXRoIGxpbmUgKHN0YXJ0cyB3aXRoIC8pXG4gICAgaWYgKGxpbmUuc3RhcnRzV2l0aCgnLycpICYmICFsaW5lLmluY2x1ZGVzKCc6JykpIHtcbiAgICAgIGN1cnJlbnRGaWxlID0gbGluZS50cmltKClcbiAgICAgIGNvbnRpbnVlXG4gICAgfVxuICAgIFxuICAgIC8vIFZpb2xhdGlvbiBsaW5lIChzdGFydHMgd2l0aCBzcGFjZXMsIGhhcyBsaW5lOmNvbCBwYXR0ZXJuKVxuICAgIGNvbnN0IG1hdGNoID0gbGluZS5tYXRjaCgvXlxccysoXFxkKyk6KFxcZCspXFxzKyh3YXJuaW5nfGVycm9yKVxccysoLis/KVxcc3syLH0oW1xcdy8tXSspJC8pXG4gICAgaWYgKG1hdGNoICYmIGN1cnJlbnRGaWxlKSB7XG4gICAgICBjb25zdCBbLCBsaW5lTnVtLCBjb2x1bW4sICwgbWVzc2FnZSwgcnVsZUlkXSA9IG1hdGNoXG4gICAgICBjb25zdCBjYW5vblBhdHRlcm4gPSBydWxlVG9QYXR0ZXJuW3J1bGVJZF0gfHwgcGFyc2VDYW5vbkZyb21NZXNzYWdlKG1lc3NhZ2UpXG4gICAgICBjb25zdCBwYXR0ZXJuID0gY2Fub25QYXR0ZXJuID8gZ2V0UGF0dGVybihjYW5vblBhdHRlcm4pIDogbnVsbFxuICAgICAgXG4gICAgICB2aW9sYXRpb25zLnB1c2goe1xuICAgICAgICBmaWxlOiBjdXJyZW50RmlsZSxcbiAgICAgICAgbGluZTogcGFyc2VJbnQobGluZU51bSwgMTApLFxuICAgICAgICBjb2x1bW46IHBhcnNlSW50KGNvbHVtbiwgMTApLFxuICAgICAgICBtZXNzYWdlOiBtZXNzYWdlLnRyaW0oKSxcbiAgICAgICAgcnVsZUlkLFxuICAgICAgICBjYW5vblBhdHRlcm4sXG4gICAgICAgIHBhdHRlcm5UaXRsZTogcGF0dGVybj8udGl0bGUgfHwgbnVsbCxcbiAgICAgIH0pXG4gICAgfVxuICB9XG4gIFxuICByZXR1cm4gdmlvbGF0aW9uc1xufVxuXG5mdW5jdGlvbiBjb3VudEJ5UGF0dGVybih2aW9sYXRpb25zOiBWaW9sYXRpb25bXSk6IFJlY29yZDxzdHJpbmcsIG51bWJlcj4ge1xuICBjb25zdCBjb3VudHM6IFJlY29yZDxzdHJpbmcsIG51bWJlcj4gPSB7fVxuICBmb3IgKGNvbnN0IHYgb2YgdmlvbGF0aW9ucykge1xuICAgIGNvbnN0IGtleSA9IHYuY2Fub25QYXR0ZXJuIHx8ICdvdGhlcidcbiAgICBjb3VudHNba2V5XSA9IChjb3VudHNba2V5XSB8fCAwKSArIDFcbiAgfVxuICByZXR1cm4gY291bnRzXG59XG5cbmZ1bmN0aW9uIGdyb3VwQnlGaWxlKHZpb2xhdGlvbnM6IFZpb2xhdGlvbltdKTogTWFwPHN0cmluZywgVmlvbGF0aW9uW10+IHtcbiAgY29uc3QgZ3JvdXBzID0gbmV3IE1hcDxzdHJpbmcsIFZpb2xhdGlvbltdPigpXG4gIGZvciAoY29uc3QgdiBvZiB2aW9sYXRpb25zKSB7XG4gICAgY29uc3QgZXhpc3RpbmcgPSBncm91cHMuZ2V0KHYuZmlsZSkgfHwgW11cbiAgICBleGlzdGluZy5wdXNoKHYpXG4gICAgZ3JvdXBzLnNldCh2LmZpbGUsIGV4aXN0aW5nKVxuICB9XG4gIHJldHVybiBncm91cHNcbn1cblxuZnVuY3Rpb24gcHJpbnRSZXBvcnQocmVzdWx0OiBBdWRpdFJlc3VsdCwgb3B0aW9uczogQXVkaXRPcHRpb25zKSB7XG4gIGlmIChvcHRpb25zLmpzb24pIHtcbiAgICBjb25zb2xlLmxvZyhKU09OLnN0cmluZ2lmeShyZXN1bHQsIG51bGwsIDIpKVxuICAgIHJldHVyblxuICB9XG5cbiAgLy8gSGVhZGVyXG4gIGNvbnNvbGUubG9nKCcnKVxuICBjb25zb2xlLmxvZyhgJHtjLmJvbGR94pWU4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWXJHtjLnJlc2V0fWApXG4gIGNvbnNvbGUubG9nKGAke2MuYm9sZH3ilZEke2MucmVzZXR9ICAgICAgICAgICAke2MuY3lhbn1HYWxsb3AgQ2Fub24ke2MucmVzZXR9ICR7Yy5kaW19diR7cmVzdWx0LnZlcnNpb259JHtjLnJlc2V0fSAke2MuYm9sZH1Db21wbGlhbmNlIFJlcG9ydCR7Yy5yZXNldH0gICAgICAgICAgICR7Yy5ib2xkfeKVkSR7Yy5yZXNldH1gKVxuICBjb25zb2xlLmxvZyhgJHtjLmJvbGR94pWa4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWdJHtjLnJlc2V0fWApXG4gIGNvbnNvbGUubG9nKCcnKVxuXG4gIGlmIChyZXN1bHQudmlvbGF0aW9ucy5sZW5ndGggPT09IDApIHtcbiAgICBjb25zb2xlLmxvZyhgICAke2MuZ3JlZW594pyTJHtjLnJlc2V0fSAke2MuYm9sZH1BbGwgZmlsZXMgcGFzcyBDYW5vbiBjb21wbGlhbmNlIGNoZWNrcyR7Yy5yZXNldH1gKVxuICAgIGNvbnNvbGUubG9nKGAgICR7Yy5kaW19UGF0aDogJHtyZXN1bHQucGF0aH0ke2MucmVzZXR9YClcbiAgICBjb25zb2xlLmxvZygnJylcbiAgICByZXR1cm5cbiAgfVxuXG4gIC8vIFN1bW1hcnlcbiAgY29uc3QgZmlsZXNXaXRoVmlvbGF0aW9ucyA9IG5ldyBTZXQocmVzdWx0LnZpb2xhdGlvbnMubWFwKHYgPT4gdi5maWxlKSkuc2l6ZVxuICBjb25zb2xlLmxvZyhgICAke2MucmVkfeKclyR7Yy5yZXNldH0gJHtjLmJvbGR9JHtyZXN1bHQudmlvbGF0aW9ucy5sZW5ndGh9IHZpb2xhdGlvbiR7cmVzdWx0LnZpb2xhdGlvbnMubGVuZ3RoID09PSAxID8gJycgOiAncyd9JHtjLnJlc2V0fSBpbiAke2ZpbGVzV2l0aFZpb2xhdGlvbnN9IGZpbGUke2ZpbGVzV2l0aFZpb2xhdGlvbnMgPT09IDEgPyAnJyA6ICdzJ31gKVxuICBjb25zb2xlLmxvZyhgICAke2MuZGltfVBhdGg6ICR7cmVzdWx0LnBhdGh9JHtjLnJlc2V0fWApXG4gIGNvbnNvbGUubG9nKCcnKVxuXG4gIC8vIFZpb2xhdGlvbnMgYnkgcGF0dGVyblxuICBjb25zb2xlLmxvZyhgJHtjLmJvbGR9ICBWaW9sYXRpb25zIGJ5IFBhdHRlcm46JHtjLnJlc2V0fWApXG4gIGZvciAoY29uc3QgW3BhdHRlcm5JZCwgY291bnRdIG9mIE9iamVjdC5lbnRyaWVzKHJlc3VsdC5zdW1tYXJ5LmJ5UGF0dGVybikuc29ydCgpKSB7XG4gICAgY29uc3QgcGF0dGVybiA9IGdldFBhdHRlcm4ocGF0dGVybklkKVxuICAgIGNvbnN0IHRpdGxlID0gcGF0dGVybj8udGl0bGUgfHwgJ090aGVyJ1xuICAgIGNvbnNvbGUubG9nKGAgICAgJHtjLnllbGxvd30ke3BhdHRlcm5JZH0ke2MucmVzZXR9ICR7dGl0bGV9OiAke2MuYm9sZH0ke2NvdW50fSR7Yy5yZXNldH1gKVxuICB9XG4gIGNvbnNvbGUubG9nKCcnKVxuXG4gIC8vIERldGFpbGVkIHZpb2xhdGlvbnMgYnkgZmlsZVxuICBjb25zb2xlLmxvZyhgJHtjLmJvbGR9ICBEZXRhaWxzOiR7Yy5yZXNldH1gKVxuICBjb25zb2xlLmxvZygnJylcblxuICBjb25zdCBieUZpbGUgPSBncm91cEJ5RmlsZShyZXN1bHQudmlvbGF0aW9ucylcbiAgZm9yIChjb25zdCBbZmlsZSwgdmlvbGF0aW9uc10gb2YgYnlGaWxlKSB7XG4gICAgLy8gU2hvcnRlbiBmaWxlIHBhdGggZm9yIGRpc3BsYXlcbiAgICBjb25zdCBzaG9ydFBhdGggPSBmaWxlLnJlcGxhY2UocHJvY2Vzcy5jd2QoKSArICcvJywgJycpXG4gICAgY29uc29sZS5sb2coYCAgJHtjLmN5YW59JHtzaG9ydFBhdGh9JHtjLnJlc2V0fWApXG4gICAgXG4gICAgZm9yIChjb25zdCB2IG9mIHZpb2xhdGlvbnMpIHtcbiAgICAgIGNvbnN0IHBhdHRlcm5MYWJlbCA9IHYuY2Fub25QYXR0ZXJuIFxuICAgICAgICA/IGAke2MueWVsbG93fVske3YuY2Fub25QYXR0ZXJufV0ke2MucmVzZXR9YCBcbiAgICAgICAgOiBgJHtjLmRpbX1bLS0tXSR7Yy5yZXNldH1gXG4gICAgICBjb25zdCBsb2NhdGlvbiA9IGAke2MuZGltfSR7di5saW5lfToke3YuY29sdW1ufSR7Yy5yZXNldH1gXG4gICAgICBcbiAgICAgIC8vIENsZWFuIHVwIG1lc3NhZ2UgKHJlbW92ZSBbQ2Fub24gWFhYXSBwcmVmaXggc2luY2Ugd2Ugc2hvdyBpdCBzZXBhcmF0ZWx5KVxuICAgICAgY29uc3QgY2xlYW5NZXNzYWdlID0gdi5tZXNzYWdlLnJlcGxhY2UoL1xcW0Nhbm9uIFxcZHszfVxcXVxccyovLCAnJylcbiAgICAgIFxuICAgICAgY29uc29sZS5sb2coYCAgICAke2xvY2F0aW9ufSAke3BhdHRlcm5MYWJlbH0gJHtjbGVhbk1lc3NhZ2V9YClcbiAgICB9XG4gICAgY29uc29sZS5sb2coJycpXG4gIH1cblxuICAvLyBGb290ZXJcbiAgY29uc29sZS5sb2coYCR7Yy5kaW19ICDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIAke2MucmVzZXR9YClcbiAgY29uc29sZS5sb2coYCAgJHtjLmRpbX1GaXggdmlvbGF0aW9ucyBtYW51YWxseSBmb2xsb3dpbmcgdGhlIENhbm9uIHBhdHRlcm5zJHtjLnJlc2V0fWApXG4gIGNvbnNvbGUubG9nKCcnKVxufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gYXVkaXQocGF0aDogc3RyaW5nLCBvcHRpb25zOiBBdWRpdE9wdGlvbnMpOiBQcm9taXNlPHZvaWQ+IHtcbiAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICBjb25zdCBhcmdzID0gW1xuICAgICAgJ2VzbGludCcsXG4gICAgICBwYXRoLFxuICAgICAgJy0tZm9ybWF0JywgJ3N0eWxpc2gnLFxuICAgIF1cblxuICAgIGlmIChvcHRpb25zLmZpeCkge1xuICAgICAgYXJncy5wdXNoKCctLWZpeCcpXG4gICAgfVxuXG4gICAgY29uc3QgZXNsaW50ID0gc3Bhd24oJ25weCcsIGFyZ3MsIHtcbiAgICAgIGN3ZDogcHJvY2Vzcy5jd2QoKSxcbiAgICAgIHN0ZGlvOiBbJ2luaGVyaXQnLCAncGlwZScsICdwaXBlJ10sXG4gICAgICBzaGVsbDogdHJ1ZSxcbiAgICB9KVxuXG4gICAgbGV0IHN0ZG91dCA9ICcnXG4gICAgbGV0IHN0ZGVyciA9ICcnXG5cbiAgICBlc2xpbnQuc3Rkb3V0Py5vbignZGF0YScsIChkYXRhKSA9PiB7XG4gICAgICBzdGRvdXQgKz0gZGF0YS50b1N0cmluZygpXG4gICAgfSlcblxuICAgIGVzbGludC5zdGRlcnI/Lm9uKCdkYXRhJywgKGRhdGEpID0+IHtcbiAgICAgIHN0ZGVyciArPSBkYXRhLnRvU3RyaW5nKClcbiAgICB9KVxuXG4gICAgZXNsaW50Lm9uKCdjbG9zZScsIChjb2RlKSA9PiB7XG4gICAgICBjb25zdCB2aW9sYXRpb25zID0gZXh0cmFjdFZpb2xhdGlvbnMoc3Rkb3V0KVxuICAgICAgXG4gICAgICBjb25zdCByZXN1bHQ6IEF1ZGl0UmVzdWx0ID0ge1xuICAgICAgICB2ZXJzaW9uLFxuICAgICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcbiAgICAgICAgcGF0aCxcbiAgICAgICAgdG90YWxGaWxlczogMCwgLy8gRVNMaW50IHN0eWxpc2ggZm9ybWF0IGRvZXNuJ3QgZ2l2ZSB1cyB0aGlzIGVhc2lseVxuICAgICAgICB2aW9sYXRpb25zLFxuICAgICAgICBzdW1tYXJ5OiB7XG4gICAgICAgICAgdG90YWw6IHZpb2xhdGlvbnMubGVuZ3RoLFxuICAgICAgICAgIGJ5UGF0dGVybjogY291bnRCeVBhdHRlcm4odmlvbGF0aW9ucyksXG4gICAgICAgIH0sXG4gICAgICB9XG5cbiAgICAgIHByaW50UmVwb3J0KHJlc3VsdCwgb3B0aW9ucylcblxuICAgICAgaWYgKG9wdGlvbnMuc3RyaWN0ICYmIHZpb2xhdGlvbnMubGVuZ3RoID4gMCkge1xuICAgICAgICBwcm9jZXNzLmV4aXQoMSlcbiAgICAgIH1cblxuICAgICAgcmVzb2x2ZSgpXG4gICAgfSlcblxuICAgIGVzbGludC5vbignZXJyb3InLCAoZXJyb3IpID0+IHtcbiAgICAgIHJlamVjdChlcnJvcilcbiAgICB9KVxuICB9KVxufVxuIl19