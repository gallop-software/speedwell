"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.audit = audit;
const child_process_1 = require("child_process");
const canon_1 = require("@gallop/canon");
// Colors for terminal output
const c = {
    reset: '\x1b[0m',
    bold: '\x1b[1m',
    dim: '\x1b[2m',
    red: '\x1b[31m',
    green: '\x1b[32m',
    yellow: '\x1b[33m',
    blue: '\x1b[34m',
    cyan: '\x1b[36m',
};
// Build rule-to-pattern mapping from Canon schema (single source of truth)
const ruleToPattern = {};
for (const pattern of canon_1.patterns) {
    if (pattern.rule) {
        ruleToPattern[pattern.rule] = pattern.id;
    }
}
function parseCanonFromMessage(message) {
    const match = message.match(/\[Canon (\d{3})\]/);
    return match ? match[1] : null;
}
function extractViolations(eslintOutput) {
    const violations = [];
    const lines = eslintOutput.split('\n');
    let currentFile = '';
    for (const line of lines) {
        // File path line (starts with /)
        if (line.startsWith('/') && !line.includes(':')) {
            currentFile = line.trim();
            continue;
        }
        // Violation line (starts with spaces, has line:col pattern)
        const match = line.match(/^\s+(\d+):(\d+)\s+(warning|error)\s+(.+?)\s{2,}([\w/-]+)$/);
        if (match && currentFile) {
            const [, lineNum, column, , message, ruleId] = match;
            const canonPattern = ruleToPattern[ruleId] || parseCanonFromMessage(message);
            const pattern = canonPattern ? (0, canon_1.getPattern)(canonPattern) : null;
            violations.push({
                file: currentFile,
                line: parseInt(lineNum, 10),
                column: parseInt(column, 10),
                message: message.trim(),
                ruleId,
                canonPattern,
                patternTitle: pattern?.title || null,
            });
        }
    }
    return violations;
}
function countByPattern(violations) {
    const counts = {};
    for (const v of violations) {
        const key = v.canonPattern || 'other';
        counts[key] = (counts[key] || 0) + 1;
    }
    return counts;
}
function groupByFile(violations) {
    const groups = new Map();
    for (const v of violations) {
        const existing = groups.get(v.file) || [];
        existing.push(v);
        groups.set(v.file, existing);
    }
    return groups;
}
function printReport(result, options) {
    if (options.json) {
        console.log(JSON.stringify(result, null, 2));
        return;
    }
    // Header
    console.log('');
    console.log(`${c.bold}╔════════════════════════════════════════════════════════════╗${c.reset}`);
    console.log(`${c.bold}║${c.reset}           ${c.cyan}Gallop Canon${c.reset} ${c.dim}v${result.version}${c.reset} ${c.bold}Compliance Report${c.reset}           ${c.bold}║${c.reset}`);
    console.log(`${c.bold}╚════════════════════════════════════════════════════════════╝${c.reset}`);
    console.log('');
    if (result.violations.length === 0) {
        console.log(`  ${c.green}✓${c.reset} ${c.bold}All files pass Canon compliance checks${c.reset}`);
        console.log(`  ${c.dim}Path: ${result.path}${c.reset}`);
        console.log('');
        return;
    }
    // Summary
    const filesWithViolations = new Set(result.violations.map(v => v.file)).size;
    console.log(`  ${c.red}✗${c.reset} ${c.bold}${result.violations.length} violation${result.violations.length === 1 ? '' : 's'}${c.reset} in ${filesWithViolations} file${filesWithViolations === 1 ? '' : 's'}`);
    console.log(`  ${c.dim}Path: ${result.path}${c.reset}`);
    console.log('');
    // Violations by pattern
    console.log(`${c.bold}  Violations by Pattern:${c.reset}`);
    for (const [patternId, count] of Object.entries(result.summary.byPattern).sort()) {
        const pattern = (0, canon_1.getPattern)(patternId);
        const title = pattern?.title || 'Other';
        console.log(`    ${c.yellow}${patternId}${c.reset} ${title}: ${c.bold}${count}${c.reset}`);
    }
    console.log('');
    // Detailed violations by file
    console.log(`${c.bold}  Details:${c.reset}`);
    console.log('');
    const byFile = groupByFile(result.violations);
    for (const [file, violations] of byFile) {
        // Shorten file path for display
        const shortPath = file.replace(process.cwd() + '/', '');
        console.log(`  ${c.cyan}${shortPath}${c.reset}`);
        for (const v of violations) {
            const patternLabel = v.canonPattern
                ? `${c.yellow}[${v.canonPattern}]${c.reset}`
                : `${c.dim}[---]${c.reset}`;
            const location = `${c.dim}${v.line}:${v.column}${c.reset}`;
            // Clean up message (remove [Canon XXX] prefix since we show it separately)
            const cleanMessage = v.message.replace(/\[Canon \d{3}\]\s*/, '');
            console.log(`    ${location} ${patternLabel} ${cleanMessage}`);
        }
        console.log('');
    }
    // Footer
    console.log(`${c.dim}  ─────────────────────────────────────────────────────────${c.reset}`);
    console.log(`  ${c.dim}Fix violations manually following the Canon patterns${c.reset}`);
    console.log(`  ${c.dim}See: https://github.com/gallop-software/canon${c.reset}`);
    console.log('');
}
async function audit(path, options) {
    return new Promise((resolve, reject) => {
        const args = [
            'eslint',
            path,
            '--format', 'stylish',
        ];
        if (options.fix) {
            args.push('--fix');
        }
        const eslint = (0, child_process_1.spawn)('npx', args, {
            cwd: process.cwd(),
            stdio: ['inherit', 'pipe', 'pipe'],
            shell: true,
        });
        let stdout = '';
        let stderr = '';
        eslint.stdout?.on('data', (data) => {
            stdout += data.toString();
        });
        eslint.stderr?.on('data', (data) => {
            stderr += data.toString();
        });
        eslint.on('close', (code) => {
            const violations = extractViolations(stdout);
            const result = {
                version: canon_1.version,
                timestamp: new Date().toISOString(),
                path,
                totalFiles: 0, // ESLint stylish format doesn't give us this easily
                violations,
                summary: {
                    total: violations.length,
                    byPattern: countByPattern(violations),
                },
            };
            printReport(result, options);
            if (options.strict && violations.length > 0) {
                process.exit(1);
            }
            resolve();
        });
        eslint.on('error', (error) => {
            reject(error);
        });
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXVkaXQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvY29tbWFuZHMvYXVkaXQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFnTEEsc0JBeURDO0FBek9ELGlEQUFxQztBQUNyQyx5Q0FBNkQ7QUE4QjdELDZCQUE2QjtBQUM3QixNQUFNLENBQUMsR0FBRztJQUNSLEtBQUssRUFBRSxTQUFTO0lBQ2hCLElBQUksRUFBRSxTQUFTO0lBQ2YsR0FBRyxFQUFFLFNBQVM7SUFDZCxHQUFHLEVBQUUsVUFBVTtJQUNmLEtBQUssRUFBRSxVQUFVO0lBQ2pCLE1BQU0sRUFBRSxVQUFVO0lBQ2xCLElBQUksRUFBRSxVQUFVO0lBQ2hCLElBQUksRUFBRSxVQUFVO0NBQ2pCLENBQUE7QUFFRCwyRUFBMkU7QUFDM0UsTUFBTSxhQUFhLEdBQTJCLEVBQUUsQ0FBQTtBQUNoRCxLQUFLLE1BQU0sT0FBTyxJQUFJLGdCQUFRLEVBQUUsQ0FBQztJQUMvQixJQUFJLE9BQU8sQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUNqQixhQUFhLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxHQUFHLE9BQU8sQ0FBQyxFQUFFLENBQUE7SUFDMUMsQ0FBQztBQUNILENBQUM7QUFFRCxTQUFTLHFCQUFxQixDQUFDLE9BQWU7SUFDNUMsTUFBTSxLQUFLLEdBQUcsT0FBTyxDQUFDLEtBQUssQ0FBQyxtQkFBbUIsQ0FBQyxDQUFBO0lBQ2hELE9BQU8sS0FBSyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQTtBQUNoQyxDQUFDO0FBRUQsU0FBUyxpQkFBaUIsQ0FBQyxZQUFvQjtJQUM3QyxNQUFNLFVBQVUsR0FBZ0IsRUFBRSxDQUFBO0lBQ2xDLE1BQU0sS0FBSyxHQUFHLFlBQVksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUE7SUFFdEMsSUFBSSxXQUFXLEdBQUcsRUFBRSxDQUFBO0lBRXBCLEtBQUssTUFB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QUFDLENBQUE7UUFDZixDQUFDLENBQUMsQ0FBQTtJQUNKLENBQUMsQ0FBQyxDQUFBO0FBQ0osQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IHNwYXduIH0gZnJvbSAnY2hpbGRfcHJvY2VzcydcbmltcG9ydCB7IHZlcnNpb24sIHBhdHRlcm5zLCBnZXRQYXR0ZXJuIH0gZnJvbSAnQGdhbGxvcC9jYW5vbidcblxuaW50ZXJmYWNlIEF1ZGl0T3B0aW9ucyB7XG4gIHN0cmljdDogYm9vbGVhblxuICBqc29uOiBib29sZWFuXG4gIGZpeDogYm9vbGVhblxufVxuXG5pbnRlcmZhY2UgVmlvbGF0aW9uIHtcbiAgZmlsZTogc3RyaW5nXG4gIGxpbmU6IG51bWJlclxuICBjb2x1bW46IG51bWJlclxuICBtZXNzYWdlOiBzdHJpbmdcbiAgcnVsZUlkOiBzdHJpbmdcbiAgY2Fub25QYXR0ZXJuOiBzdHJpbmcgfCBudWxsXG4gIHBhdHRlcm5UaXRsZTogc3RyaW5nIHwgbnVsbFxufVxuXG5pbnRlcmZhY2UgQXVkaXRSZXN1bHQge1xuICB2ZXJzaW9uOiBzdHJpbmdcbiAgdGltZXN0YW1wOiBzdHJpbmdcbiAgcGF0aDogc3RyaW5nXG4gIHRvdGFsRmlsZXM6IG51bWJlclxuICB2aW9sYXRpb25zOiBWaW9sYXRpb25bXVxuICBzdW1tYXJ5OiB7XG4gICAgdG90YWw6IG51bWJlclxuICAgIGJ5UGF0dGVybjogUmVjb3JkPHN0cmluZywgbnVtYmVyPlxuICB9XG59XG5cbi8vIENvbG9ycyBmb3IgdGVybWluYWwgb3V0cHV0XG5jb25zdCBjID0ge1xuICByZXNldDogJ1xceDFiWzBtJyxcbiAgYm9sZDogJ1xceDFiWzFtJyxcbiAgZGltOiAnXFx4MWJbMm0nLFxuICByZWQ6ICdcXHgxYlszMW0nLFxuICBncmVlbjogJ1xceDFiWzMybScsXG4gIHllbGxvdzogJ1xceDFiWzMzbScsXG4gIGJsdWU6ICdcXHgxYlszNG0nLFxuICBjeWFuOiAnXFx4MWJbMzZtJyxcbn1cblxuLy8gQnVpbGQgcnVsZS10by1wYXR0ZXJuIG1hcHBpbmcgZnJvbSBDYW5vbiBzY2hlbWEgKHNpbmdsZSBzb3VyY2Ugb2YgdHJ1dGgpXG5jb25zdCBydWxlVG9QYXR0ZXJuOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+ID0ge31cbmZvciAoY29uc3QgcGF0dGVybiBvZiBwYXR0ZXJucykge1xuICBpZiAocGF0dGVybi5ydWxlKSB7XG4gICAgcnVsZVRvUGF0dGVybltwYXR0ZXJuLnJ1bGVdID0gcGF0dGVybi5pZFxuICB9XG59XG5cbmZ1bmN0aW9uIHBhcnNlQ2Fub25Gcm9tTWVzc2FnZShtZXNzYWdlOiBzdHJpbmcpOiBzdHJpbmcgfCBudWxsIHtcbiAgY29uc3QgbWF0Y2ggPSBtZXNzYWdlLm1hdGNoKC9cXFtDYW5vbiAoXFxkezN9KVxcXS8pXG4gIHJldHVybiBtYXRjaCA/IG1hdGNoWzFdIDogbnVsbFxufVxuXG5mdW5jdGlvbiBleHRyYWN0VmlvbGF0aW9ucyhlc2xpbnRPdXRwdXQ6IHN0cmluZyk6IFZpb2xhdGlvbltdIHtcbiAgY29uc3QgdmlvbGF0aW9uczogVmlvbGF0aW9uW10gPSBbXVxuICBjb25zdCBsaW5lcyA9IGVzbGludE91dHB1dC5zcGxpdCgnXFxuJylcbiAgXG4gIGxldCBjdXJyZW50RmlsZSA9ICcnXG4gIFxuICBmb3IgKGNvbnN0IGxpbmUgb2YgbGluZXMpIHtcbiAgICAvLyBGaWxlIHBhdGggbGluZSAoc3RhcnRzIHdpdGggLylcbiAgICBpZiAobGluZS5zdGFydHNXaXRoKCcvJykgJiYgIWxpbmUuaW5jbHVkZXMoJzonKSkge1xuICAgICAgY3VycmVudEZpbGUgPSBsaW5lLnRyaW0oKVxuICAgICAgY29udGludWVcbiAgICB9XG4gICAgXG4gICAgLy8gVmlvbGF0aW9uIGxpbmUgKHN0YXJ0cyB3aXRoIHNwYWNlcywgaGFzIGxpbmU6Y29sIHBhdHRlcm4pXG4gICAgY29uc3QgbWF0Y2ggPSBsaW5lLm1hdGNoKC9eXFxzKyhcXGQrKTooXFxkKylcXHMrKHdhcm5pbmd8ZXJyb3IpXFxzKyguKz8pXFxzezIsfShbXFx3Ly1dKykkLylcbiAgICBpZiAobWF0Y2ggJiYgY3VycmVudEZpbGUpIHtcbiAgICAgIGNvbnN0IFssIGxpbmVOdW0sIGNvbHVtbiwgLCBtZXNzYWdlLCBydWxlSWRdID0gbWF0Y2hcbiAgICAgIGNvbnN0IGNhbm9uUGF0dGVybiA9IHJ1bGVUb1BhdHRlcm5bcnVsZUlkXSB8fCBwYXJzZUNhbm9uRnJvbU1lc3NhZ2UobWVzc2FnZSlcbiAgICAgIGNvbnN0IHBhdHRlcm4gPSBjYW5vblBhdHRlcm4gPyBnZXRQYXR0ZXJuKGNhbm9uUGF0dGVybikgOiBudWxsXG4gICAgICBcbiAgICAgIHZpb2xhdGlvbnMucHVzaCh7XG4gICAgICAgIGZpbGU6IGN1cnJlbnRGaWxlLFxuICAgICAgICBsaW5lOiBwYXJzZUludChsaW5lTnVtLCAxMCksXG4gICAgICAgIGNvbHVtbjogcGFyc2VJbnQoY29sdW1uLCAxMCksXG4gICAgICAgIG1lc3NhZ2U6IG1lc3NhZ2UudHJpbSgpLFxuICAgICAgICBydWxlSWQsXG4gICAgICAgIGNhbm9uUGF0dGVybixcbiAgICAgICAgcGF0dGVyblRpdGxlOiBwYXR0ZXJuPy50aXRsZSB8fCBudWxsLFxuICAgICAgfSlcbiAgICB9XG4gIH1cbiAgXG4gIHJldHVybiB2aW9sYXRpb25zXG59XG5cbmZ1bmN0aW9uIGNvdW50QnlQYXR0ZXJuKHZpb2xhdGlvbnM6IFZpb2xhdGlvbltdKTogUmVjb3JkPHN0cmluZywgbnVtYmVyPiB7XG4gIGNvbnN0IGNvdW50czogUmVjb3JkPHN0cmluZywgbnVtYmVyPiA9IHt9XG4gIGZvciAoY29uc3QgdiBvZiB2aW9sYXRpb25zKSB7XG4gICAgY29uc3Qga2V5ID0gdi5jYW5vblBhdHRlcm4gfHwgJ290aGVyJ1xuICAgIGNvdW50c1trZXldID0gKGNvdW50c1trZXldIHx8IDApICsgMVxuICB9XG4gIHJldHVybiBjb3VudHNcbn1cblxuZnVuY3Rpb24gZ3JvdXBCeUZpbGUodmlvbGF0aW9uczogVmlvbGF0aW9uW10pOiBNYXA8c3RyaW5nLCBWaW9sYXRpb25bXT4ge1xuICBjb25zdCBncm91cHMgPSBuZXcgTWFwPHN0cmluZywgVmlvbGF0aW9uW10+KClcbiAgZm9yIChjb25zdCB2IG9mIHZpb2xhdGlvbnMpIHtcbiAgICBjb25zdCBleGlzdGluZyA9IGdyb3Vwcy5nZXQodi5maWxlKSB8fCBbXVxuICAgIGV4aXN0aW5nLnB1c2godilcbiAgICBncm91cHMuc2V0KHYuZmlsZSwgZXhpc3RpbmcpXG4gIH1cbiAgcmV0dXJuIGdyb3Vwc1xufVxuXG5mdW5jdGlvbiBwcmludFJlcG9ydChyZXN1bHQ6IEF1ZGl0UmVzdWx0LCBvcHRpb25zOiBBdWRpdE9wdGlvbnMpIHtcbiAgaWYgKG9wdGlvbnMuanNvbikge1xuICAgIGNvbnNvbGUubG9nKEpTT04uc3RyaW5naWZ5KHJlc3VsdCwgbnVsbCwgMikpXG4gICAgcmV0dXJuXG4gIH1cblxuICAvLyBIZWFkZXJcbiAgY29uc29sZS5sb2coJycpXG4gIGNvbnNvbGUubG9nKGAke2MuYm9sZH3ilZTilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZcke2MucmVzZXR9YClcbiAgY29uc29sZS5sb2coYCR7Yy5ib2xkfeKVkSR7Yy5yZXNldH0gICAgICAgICAgICR7Yy5jeWFufUdhbGxvcCBDYW5vbiR7Yy5yZXNldH0gJHtjLmRpbX12JHtyZXN1bHQudmVyc2lvbn0ke2MucmVzZXR9ICR7Yy5ib2xkfUNvbXBsaWFuY2UgUmVwb3J0JHtjLnJlc2V0fSAgICAgICAgICAgJHtjLmJvbGR94pWRJHtjLnJlc2V0fWApXG4gIGNvbnNvbGUubG9nKGAke2MuYm9sZH3ilZrilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZ0ke2MucmVzZXR9YClcbiAgY29uc29sZS5sb2coJycpXG5cbiAgaWYgKHJlc3VsdC52aW9sYXRpb25zLmxlbmd0aCA9PT0gMCkge1xuICAgIGNvbnNvbGUubG9nKGAgICR7Yy5ncmVlbn3inJMke2MucmVzZXR9ICR7Yy5ib2xkfUFsbCBmaWxlcyBwYXNzIENhbm9uIGNvbXBsaWFuY2UgY2hlY2tzJHtjLnJlc2V0fWApXG4gICAgY29uc29sZS5sb2coYCAgJHtjLmRpbX1QYXRoOiAke3Jlc3VsdC5wYXRofSR7Yy5yZXNldH1gKVxuICAgIGNvbnNvbGUubG9nKCcnKVxuICAgIHJldHVyblxuICB9XG5cbiAgLy8gU3VtbWFyeVxuICBjb25zdCBmaWxlc1dpdGhWaW9sYXRpb25zID0gbmV3IFNldChyZXN1bHQudmlvbGF0aW9ucy5tYXAodiA9PiB2LmZpbGUpKS5zaXplXG4gIGNvbnNvbGUubG9nKGAgICR7Yy5yZWR94pyXJHtjLnJlc2V0fSAke2MuYm9sZH0ke3Jlc3VsdC52aW9sYXRpb25zLmxlbmd0aH0gdmlvbGF0aW9uJHtyZXN1bHQudmlvbGF0aW9ucy5sZW5ndGggPT09IDEgPyAnJyA6ICdzJ30ke2MucmVzZXR9IGluICR7ZmlsZXNXaXRoVmlvbGF0aW9uc30gZmlsZSR7ZmlsZXNXaXRoVmlvbGF0aW9ucyA9PT0gMSA/ICcnIDogJ3MnfWApXG4gIGNvbnNvbGUubG9nKGAgICR7Yy5kaW19UGF0aDogJHtyZXN1bHQucGF0aH0ke2MucmVzZXR9YClcbiAgY29uc29sZS5sb2coJycpXG5cbiAgLy8gVmlvbGF0aW9ucyBieSBwYXR0ZXJuXG4gIGNvbnNvbGUubG9nKGAke2MuYm9sZH0gIFZpb2xhdGlvbnMgYnkgUGF0dGVybjoke2MucmVzZXR9YClcbiAgZm9yIChjb25zdCBbcGF0dGVybklkLCBjb3VudF0gb2YgT2JqZWN0LmVudHJpZXMocmVzdWx0LnN1bW1hcnkuYnlQYXR0ZXJuKS5zb3J0KCkpIHtcbiAgICBjb25zdCBwYXR0ZXJuID0gZ2V0UGF0dGVybihwYXR0ZXJuSWQpXG4gICAgY29uc3QgdGl0bGUgPSBwYXR0ZXJuPy50aXRsZSB8fCAnT3RoZXInXG4gICAgY29uc29sZS5sb2coYCAgICAke2MueWVsbG93fSR7cGF0dGVybklkfSR7Yy5yZXNldH0gJHt0aXRsZX06ICR7Yy5ib2xkfSR7Y291bnR9JHtjLnJlc2V0fWApXG4gIH1cbiAgY29uc29sZS5sb2coJycpXG5cbiAgLy8gRGV0YWlsZWQgdmlvbGF0aW9ucyBieSBmaWxlXG4gIGNvbnNvbGUubG9nKGAke2MuYm9sZH0gIERldGFpbHM6JHtjLnJlc2V0fWApXG4gIGNvbnNvbGUubG9nKCcnKVxuXG4gIGNvbnN0IGJ5RmlsZSA9IGdyb3VwQnlGaWxlKHJlc3VsdC52aW9sYXRpb25zKVxuICBmb3IgKGNvbnN0IFtmaWxlLCB2aW9sYXRpb25zXSBvZiBieUZpbGUpIHtcbiAgICAvLyBTaG9ydGVuIGZpbGUgcGF0aCBmb3IgZGlzcGxheVxuICAgIGNvbnN0IHNob3J0UGF0aCA9IGZpbGUucmVwbGFjZShwcm9jZXNzLmN3ZCgpICsgJy8nLCAnJylcbiAgICBjb25zb2xlLmxvZyhgICAke2MuY3lhbn0ke3Nob3J0UGF0aH0ke2MucmVzZXR9YClcbiAgICBcbiAgICBmb3IgKGNvbnN0IHYgb2YgdmlvbGF0aW9ucykge1xuICAgICAgY29uc3QgcGF0dGVybkxhYmVsID0gdi5jYW5vblBhdHRlcm4gXG4gICAgICAgID8gYCR7Yy55ZWxsb3d9WyR7di5jYW5vblBhdHRlcm59XSR7Yy5yZXNldH1gIFxuICAgICAgICA6IGAke2MuZGltfVstLS1dJHtjLnJlc2V0fWBcbiAgICAgIGNvbnN0IGxvY2F0aW9uID0gYCR7Yy5kaW19JHt2LmxpbmV9OiR7di5jb2x1bW59JHtjLnJlc2V0fWBcbiAgICAgIFxuICAgICAgLy8gQ2xlYW4gdXAgbWVzc2FnZSAocmVtb3ZlIFtDYW5vbiBYWFhdIHByZWZpeCBzaW5jZSB3ZSBzaG93IGl0IHNlcGFyYXRlbHkpXG4gICAgICBjb25zdCBjbGVhbk1lc3NhZ2UgPSB2Lm1lc3NhZ2UucmVwbGFjZSgvXFxbQ2Fub24gXFxkezN9XFxdXFxzKi8sICcnKVxuICAgICAgXG4gICAgICBjb25zb2xlLmxvZyhgICAgICR7bG9jYXRpb259ICR7cGF0dGVybkxhYmVsfSAke2NsZWFuTWVzc2FnZX1gKVxuICAgIH1cbiAgICBjb25zb2xlLmxvZygnJylcbiAgfVxuXG4gIC8vIEZvb3RlclxuICBjb25zb2xlLmxvZyhgJHtjLmRpbX0gIOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgCR7Yy5yZXNldH1gKVxuICBjb25zb2xlLmxvZyhgICAke2MuZGltfUZpeCB2aW9sYXRpb25zIG1hbnVhbGx5IGZvbGxvd2luZyB0aGUgQ2Fub24gcGF0dGVybnMke2MucmVzZXR9YClcbiAgY29uc29sZS5sb2coYCAgJHtjLmRpbX1TZWU6IGh0dHBzOi8vZ2l0aHViLmNvbS9nYWxsb3Atc29mdHdhcmUvY2Fub24ke2MucmVzZXR9YClcbiAgY29uc29sZS5sb2coJycpXG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBhdWRpdChwYXRoOiBzdHJpbmcsIG9wdGlvbnM6IEF1ZGl0T3B0aW9ucyk6IFByb21pc2U8dm9pZD4ge1xuICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgIGNvbnN0IGFyZ3MgPSBbXG4gICAgICAnZXNsaW50JyxcbiAgICAgIHBhdGgsXG4gICAgICAnLS1mb3JtYXQnLCAnc3R5bGlzaCcsXG4gICAgXVxuXG4gICAgaWYgKG9wdGlvbnMuZml4KSB7XG4gICAgICBhcmdzLnB1c2goJy0tZml4JylcbiAgICB9XG5cbiAgICBjb25zdCBlc2xpbnQgPSBzcGF3bignbnB4JywgYXJncywge1xuICAgICAgY3dkOiBwcm9jZXNzLmN3ZCgpLFxuICAgICAgc3RkaW86IFsnaW5oZXJpdCcsICdwaXBlJywgJ3BpcGUnXSxcbiAgICAgIHNoZWxsOiB0cnVlLFxuICAgIH0pXG5cbiAgICBsZXQgc3Rkb3V0ID0gJydcbiAgICBsZXQgc3RkZXJyID0gJydcblxuICAgIGVzbGludC5zdGRvdXQ/Lm9uKCdkYXRhJywgKGRhdGEpID0+IHtcbiAgICAgIHN0ZG91dCArPSBkYXRhLnRvU3RyaW5nKClcbiAgICB9KVxuXG4gICAgZXNsaW50LnN0ZGVycj8ub24oJ2RhdGEnLCAoZGF0YSkgPT4ge1xuICAgICAgc3RkZXJyICs9IGRhdGEudG9TdHJpbmcoKVxuICAgIH0pXG5cbiAgICBlc2xpbnQub24oJ2Nsb3NlJywgKGNvZGUpID0+IHtcbiAgICAgIGNvbnN0IHZpb2xhdGlvbnMgPSBleHRyYWN0VmlvbGF0aW9ucyhzdGRvdXQpXG4gICAgICBcbiAgICAgIGNvbnN0IHJlc3VsdDogQXVkaXRSZXN1bHQgPSB7XG4gICAgICAgIHZlcnNpb24sXG4gICAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxuICAgICAgICBwYXRoLFxuICAgICAgICB0b3RhbEZpbGVzOiAwLCAvLyBFU0xpbnQgc3R5bGlzaCBmb3JtYXQgZG9lc24ndCBnaXZlIHVzIHRoaXMgZWFzaWx5XG4gICAgICAgIHZpb2xhdGlvbnMsXG4gICAgICAgIHN1bW1hcnk6IHtcbiAgICAgICAgICB0b3RhbDogdmlvbGF0aW9ucy5sZW5ndGgsXG4gICAgICAgICAgYnlQYXR0ZXJuOiBjb3VudEJ5UGF0dGVybih2aW9sYXRpb25zKSxcbiAgICAgICAgfSxcbiAgICAgIH1cblxuICAgICAgcHJpbnRSZXBvcnQocmVzdWx0LCBvcHRpb25zKVxuXG4gICAgICBpZiAob3B0aW9ucy5zdHJpY3QgJiYgdmlvbGF0aW9ucy5sZW5ndGggPiAwKSB7XG4gICAgICAgIHByb2Nlc3MuZXhpdCgxKVxuICAgICAgfVxuXG4gICAgICByZXNvbHZlKClcbiAgICB9KVxuXG4gICAgZXNsaW50Lm9uKCdlcnJvcicsIChlcnJvcikgPT4ge1xuICAgICAgcmVqZWN0KGVycm9yKVxuICAgIH0pXG4gIH0pXG59XG4iXX0=