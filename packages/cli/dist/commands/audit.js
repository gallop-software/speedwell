"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.audit = audit;
const child_process_1 = require("child_process");
const canon_1 = require("@gallop/canon");
// Colors for terminal output
const c = {
    reset: '\x1b[0m',
    bold: '\x1b[1m',
    dim: '\x1b[2m',
    red: '\x1b[31m',
    green: '\x1b[32m',
    yellow: '\x1b[33m',
    blue: '\x1b[34m',
    cyan: '\x1b[36m',
};
// Map ESLint rule IDs to Canon patterns
const ruleToPattern = {
    'gallop/no-client-blocks': '001',
    'gallop/no-container-in-section': '002',
    'gallop/prefer-typography-components': '003',
    'gallop/prefer-component-props': '004',
};
function parseCanonFromMessage(message) {
    const match = message.match(/\[Canon (\d{3})\]/);
    return match ? match[1] : null;
}
function extractViolations(eslintOutput) {
    const violations = [];
    const lines = eslintOutput.split('\n');
    let currentFile = '';
    for (const line of lines) {
        // File path line (starts with /)
        if (line.startsWith('/') && !line.includes(':')) {
            currentFile = line.trim();
            continue;
        }
        // Violation line (starts with spaces, has line:col pattern)
        const match = line.match(/^\s+(\d+):(\d+)\s+(warning|error)\s+(.+?)\s{2,}([\w/-]+)$/);
        if (match && currentFile) {
            const [, lineNum, column, , message, ruleId] = match;
            const canonPattern = ruleToPattern[ruleId] || parseCanonFromMessage(message);
            const pattern = canonPattern ? (0, canon_1.getPattern)(canonPattern) : null;
            violations.push({
                file: currentFile,
                line: parseInt(lineNum, 10),
                column: parseInt(column, 10),
                message: message.trim(),
                ruleId,
                canonPattern,
                patternTitle: pattern?.title || null,
            });
        }
    }
    return violations;
}
function countByPattern(violations) {
    const counts = {};
    for (const v of violations) {
        const key = v.canonPattern || 'other';
        counts[key] = (counts[key] || 0) + 1;
    }
    return counts;
}
function groupByFile(violations) {
    const groups = new Map();
    for (const v of violations) {
        const existing = groups.get(v.file) || [];
        existing.push(v);
        groups.set(v.file, existing);
    }
    return groups;
}
function printReport(result, options) {
    if (options.json) {
        console.log(JSON.stringify(result, null, 2));
        return;
    }
    // Header
    console.log('');
    console.log(`${c.bold}╔════════════════════════════════════════════════════════════╗${c.reset}`);
    console.log(`${c.bold}║${c.reset}           ${c.cyan}Gallop Canon${c.reset} ${c.dim}v${result.version}${c.reset} ${c.bold}Compliance Report${c.reset}           ${c.bold}║${c.reset}`);
    console.log(`${c.bold}╚════════════════════════════════════════════════════════════╝${c.reset}`);
    console.log('');
    if (result.violations.length === 0) {
        console.log(`  ${c.green}✓${c.reset} ${c.bold}All files pass Canon compliance checks${c.reset}`);
        console.log(`  ${c.dim}Path: ${result.path}${c.reset}`);
        console.log('');
        return;
    }
    // Summary
    const filesWithViolations = new Set(result.violations.map(v => v.file)).size;
    console.log(`  ${c.red}✗${c.reset} ${c.bold}${result.violations.length} violation${result.violations.length === 1 ? '' : 's'}${c.reset} in ${filesWithViolations} file${filesWithViolations === 1 ? '' : 's'}`);
    console.log(`  ${c.dim}Path: ${result.path}${c.reset}`);
    console.log('');
    // Violations by pattern
    console.log(`${c.bold}  Violations by Pattern:${c.reset}`);
    for (const [patternId, count] of Object.entries(result.summary.byPattern).sort()) {
        const pattern = (0, canon_1.getPattern)(patternId);
        const title = pattern?.title || 'Other';
        console.log(`    ${c.yellow}${patternId}${c.reset} ${title}: ${c.bold}${count}${c.reset}`);
    }
    console.log('');
    // Detailed violations by file
    console.log(`${c.bold}  Details:${c.reset}`);
    console.log('');
    const byFile = groupByFile(result.violations);
    for (const [file, violations] of byFile) {
        // Shorten file path for display
        const shortPath = file.replace(process.cwd() + '/', '');
        console.log(`  ${c.cyan}${shortPath}${c.reset}`);
        for (const v of violations) {
            const patternLabel = v.canonPattern
                ? `${c.yellow}[${v.canonPattern}]${c.reset}`
                : `${c.dim}[---]${c.reset}`;
            const location = `${c.dim}${v.line}:${v.column}${c.reset}`;
            // Clean up message (remove [Canon XXX] prefix since we show it separately)
            const cleanMessage = v.message.replace(/\[Canon \d{3}\]\s*/, '');
            console.log(`    ${location} ${patternLabel} ${cleanMessage}`);
        }
        console.log('');
    }
    // Footer
    console.log(`${c.dim}  ─────────────────────────────────────────────────────────${c.reset}`);
    console.log(`  ${c.dim}Run with --fix to auto-fix where possible${c.reset}`);
    console.log(`  ${c.dim}See: https://github.com/gallop-software/canon${c.reset}`);
    console.log('');
}
async function audit(path, options) {
    return new Promise((resolve, reject) => {
        const args = [
            'eslint',
            path,
            '--format', 'stylish',
        ];
        if (options.fix) {
            args.push('--fix');
        }
        const eslint = (0, child_process_1.spawn)('npx', args, {
            cwd: process.cwd(),
            stdio: ['inherit', 'pipe', 'pipe'],
            shell: true,
        });
        let stdout = '';
        let stderr = '';
        eslint.stdout?.on('data', (data) => {
            stdout += data.toString();
        });
        eslint.stderr?.on('data', (data) => {
            stderr += data.toString();
        });
        eslint.on('close', (code) => {
            const violations = extractViolations(stdout);
            const result = {
                version: canon_1.version,
                timestamp: new Date().toISOString(),
                path,
                totalFiles: 0, // ESLint stylish format doesn't give us this easily
                violations,
                summary: {
                    total: violations.length,
                    byPattern: countByPattern(violations),
                },
            };
            printReport(result, options);
            if (options.strict && violations.length > 0) {
                process.exit(1);
            }
            resolve();
        });
        eslint.on('error', (error) => {
            reject(error);
        });
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXVkaXQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvY29tbWFuZHMvYXVkaXQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFnTEEsc0JBeURDO0FBek9ELGlEQUFxQztBQUNyQyx5Q0FBNkQ7QUE4QjdELDZCQUE2QjtBQUM3QixNQUFNLENBQUMsR0FBRztJQUNSLEtBQUssRUFBRSxTQUFTO0lBQ2hCLElBQUksRUFBRSxTQUFTO0lBQ2YsR0FBRyxFQUFFLFNBQVM7SUFDZCxHQUFHLEVBQUUsVUFBVTtJQUNmLEtBQUssRUFBRSxVQUFVO0lBQ2pCLE1BQU0sRUFBRSxVQUFVO0lBQ2xCLElBQUksRUFBRSxVQUFVO0lBQ2hCLElBQUksRUFBRSxVQUFVO0NBQ2pCLENBQUE7QUFFRCx3Q0FBd0M7QUFDeEMsTUFBTSxhQUFhLEdBQTJCO0lBQzVDLHlCQUF5QixFQUFFLEtBQUs7SUFDaEMsZ0NBQWdDLEVBQUUsS0FBSztJQUN2QyxxQ0FBcUMsRUFBRSxLQUFLO0lBQzVDLCtCQUErQixFQUFFLEtBQUs7Q0FDdkMsQ0FBQTtBQUVELFNBQVMscUJBQXFCLENBQUMsT0FBZTtJQUM1QyxNQUFNLEtBQUssR0FBRyxPQUFPLENBQUMsS0FBSyxDQUFDLG1CQUFtQixDQUFDLENBQUE7SUFDaEQsT0FBTyxLQUFLLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFBO0FBQ2hDLENBQUM7QUFFRCxTQUFTLGlCQUFpQixDQUFDLFlBQW9CO0lBQzdDLE1BQU0sVUFBVSxHQUFnQixFQUFFLENBQUE7SUFDbEMsTUFBTSxLQUFLLEdBQUcsWUFBWSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQTtJQUV0QyxJQUFJLFdBQVcsR0FBRyxFQUFFLENBQUE7SUFFcEIsS0FBSyxNQUFNLElBQUksSUFBSSxLQUFLLEVBQUUsQ0FBQztRQUN6QixpQ0FBaUM7UUFDakMsSUFBSSxJQUFJLENBQUMsVUFBVSxD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c0NvbnRlbnQiOlsiaW1wb3J0IHsgc3Bhd24gfSBmcm9tICdjaGlsZF9wcm9jZXNzJ1xuaW1wb3J0IHsgdmVyc2lvbiwgcGF0dGVybnMsIGdldFBhdHRlcm4gfSBmcm9tICdAZ2FsbG9wL2Nhbm9uJ1xuXG5pbnRlcmZhY2UgQXVkaXRPcHRpb25zIHtcbiAgc3RyaWN0OiBib29sZWFuXG4gIGpzb246IGJvb2xlYW5cbiAgZml4OiBib29sZWFuXG59XG5cbmludGVyZmFjZSBWaW9sYXRpb24ge1xuICBmaWxlOiBzdHJpbmdcbiAgbGluZTogbnVtYmVyXG4gIGNvbHVtbjogbnVtYmVyXG4gIG1lc3NhZ2U6IHN0cmluZ1xuICBydWxlSWQ6IHN0cmluZ1xuICBjYW5vblBhdHRlcm46IHN0cmluZyB8IG51bGxcbiAgcGF0dGVyblRpdGxlOiBzdHJpbmcgfCBudWxsXG59XG5cbmludGVyZmFjZSBBdWRpdFJlc3VsdCB7XG4gIHZlcnNpb246IHN0cmluZ1xuICB0aW1lc3RhbXA6IHN0cmluZ1xuICBwYXRoOiBzdHJpbmdcbiAgdG90YWxGaWxlczogbnVtYmVyXG4gIHZpb2xhdGlvbnM6IFZpb2xhdGlvbltdXG4gIHN1bW1hcnk6IHtcbiAgICB0b3RhbDogbnVtYmVyXG4gICAgYnlQYXR0ZXJuOiBSZWNvcmQ8c3RyaW5nLCBudW1iZXI+XG4gIH1cbn1cblxuLy8gQ29sb3JzIGZvciB0ZXJtaW5hbCBvdXRwdXRcbmNvbnN0IGMgPSB7XG4gIHJlc2V0OiAnXFx4MWJbMG0nLFxuICBib2xkOiAnXFx4MWJbMW0nLFxuICBkaW06ICdcXHgxYlsybScsXG4gIHJlZDogJ1xceDFiWzMxbScsXG4gIGdyZWVuOiAnXFx4MWJbMzJtJyxcbiAgeWVsbG93OiAnXFx4MWJbMzNtJyxcbiAgYmx1ZTogJ1xceDFiWzM0bScsXG4gIGN5YW46ICdcXHgxYlszNm0nLFxufVxuXG4vLyBNYXAgRVNMaW50IHJ1bGUgSURzIHRvIENhbm9uIHBhdHRlcm5zXG5jb25zdCBydWxlVG9QYXR0ZXJuOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+ID0ge1xuICAnZ2FsbG9wL25vLWNsaWVudC1ibG9ja3MnOiAnMDAxJyxcbiAgJ2dhbGxvcC9uby1jb250YWluZXItaW4tc2VjdGlvbic6ICcwMDInLFxuICAnZ2FsbG9wL3ByZWZlci10eXBvZ3JhcGh5LWNvbXBvbmVudHMnOiAnMDAzJyxcbiAgJ2dhbGxvcC9wcmVmZXItY29tcG9uZW50LXByb3BzJzogJzAwNCcsXG59XG5cbmZ1bmN0aW9uIHBhcnNlQ2Fub25Gcm9tTWVzc2FnZShtZXNzYWdlOiBzdHJpbmcpOiBzdHJpbmcgfCBudWxsIHtcbiAgY29uc3QgbWF0Y2ggPSBtZXNzYWdlLm1hdGNoKC9cXFtDYW5vbiAoXFxkezN9KVxcXS8pXG4gIHJldHVybiBtYXRjaCA/IG1hdGNoWzFdIDogbnVsbFxufVxuXG5mdW5jdGlvbiBleHRyYWN0VmlvbGF0aW9ucyhlc2xpbnRPdXRwdXQ6IHN0cmluZyk6IFZpb2xhdGlvbltdIHtcbiAgY29uc3QgdmlvbGF0aW9uczogVmlvbGF0aW9uW10gPSBbXVxuICBjb25zdCBsaW5lcyA9IGVzbGludE91dHB1dC5zcGxpdCgnXFxuJylcbiAgXG4gIGxldCBjdXJyZW50RmlsZSA9ICcnXG4gIFxuICBmb3IgKGNvbnN0IGxpbmUgb2YgbGluZXMpIHtcbiAgICAvLyBGaWxlIHBhdGggbGluZSAoc3RhcnRzIHdpdGggLylcbiAgICBpZiAobGluZS5zdGFydHNXaXRoKCcvJykgJiYgIWxpbmUuaW5jbHVkZXMoJzonKSkge1xuICAgICAgY3VycmVudEZpbGUgPSBsaW5lLnRyaW0oKVxuICAgICAgY29udGludWVcbiAgICB9XG4gICAgXG4gICAgLy8gVmlvbGF0aW9uIGxpbmUgKHN0YXJ0cyB3aXRoIHNwYWNlcywgaGFzIGxpbmU6Y29sIHBhdHRlcm4pXG4gICAgY29uc3QgbWF0Y2ggPSBsaW5lLm1hdGNoKC9eXFxzKyhcXGQrKTooXFxkKylcXHMrKHdhcm5pbmd8ZXJyb3IpXFxzKyguKz8pXFxzezIsfShbXFx3Ly1dKykkLylcbiAgICBpZiAobWF0Y2ggJiYgY3VycmVudEZpbGUpIHtcbiAgICAgIGNvbnN0IFssIGxpbmVOdW0sIGNvbHVtbiwgLCBtZXNzYWdlLCBydWxlSWRdID0gbWF0Y2hcbiAgICAgIGNvbnN0IGNhbm9uUGF0dGVybiA9IHJ1bGVUb1BhdHRlcm5bcnVsZUlkXSB8fCBwYXJzZUNhbm9uRnJvbU1lc3NhZ2UobWVzc2FnZSlcbiAgICAgIGNvbnN0IHBhdHRlcm4gPSBjYW5vblBhdHRlcm4gPyBnZXRQYXR0ZXJuKGNhbm9uUGF0dGVybikgOiBudWxsXG4gICAgICBcbiAgICAgIHZpb2xhdGlvbnMucHVzaCh7XG4gICAgICAgIGZpbGU6IGN1cnJlbnRGaWxlLFxuICAgICAgICBsaW5lOiBwYXJzZUludChsaW5lTnVtLCAxMCksXG4gICAgICAgIGNvbHVtbjogcGFyc2VJbnQoY29sdW1uLCAxMCksXG4gICAgICAgIG1lc3NhZ2U6IG1lc3NhZ2UudHJpbSgpLFxuICAgICAgICBydWxlSWQsXG4gICAgICAgIGNhbm9uUGF0dGVybixcbiAgICAgICAgcGF0dGVyblRpdGxlOiBwYXR0ZXJuPy50aXRsZSB8fCBudWxsLFxuICAgICAgfSlcbiAgICB9XG4gIH1cbiAgXG4gIHJldHVybiB2aW9sYXRpb25zXG59XG5cbmZ1bmN0aW9uIGNvdW50QnlQYXR0ZXJuKHZpb2xhdGlvbnM6IFZpb2xhdGlvbltdKTogUmVjb3JkPHN0cmluZywgbnVtYmVyPiB7XG4gIGNvbnN0IGNvdW50czogUmVjb3JkPHN0cmluZywgbnVtYmVyPiA9IHt9XG4gIGZvciAoY29uc3QgdiBvZiB2aW9sYXRpb25zKSB7XG4gICAgY29uc3Qga2V5ID0gdi5jYW5vblBhdHRlcm4gfHwgJ290aGVyJ1xuICAgIGNvdW50c1trZXldID0gKGNvdW50c1trZXldIHx8IDApICsgMVxuICB9XG4gIHJldHVybiBjb3VudHNcbn1cblxuZnVuY3Rpb24gZ3JvdXBCeUZpbGUodmlvbGF0aW9uczogVmlvbGF0aW9uW10pOiBNYXA8c3RyaW5nLCBWaW9sYXRpb25bXT4ge1xuICBjb25zdCBncm91cHMgPSBuZXcgTWFwPHN0cmluZywgVmlvbGF0aW9uW10+KClcbiAgZm9yIChjb25zdCB2IG9mIHZpb2xhdGlvbnMpIHtcbiAgICBjb25zdCBleGlzdGluZyA9IGdyb3Vwcy5nZXQodi5maWxlKSB8fCBbXVxuICAgIGV4aXN0aW5nLnB1c2godilcbiAgICBncm91cHMuc2V0KHYuZmlsZSwgZXhpc3RpbmcpXG4gIH1cbiAgcmV0dXJuIGdyb3Vwc1xufVxuXG5mdW5jdGlvbiBwcmludFJlcG9ydChyZXN1bHQ6IEF1ZGl0UmVzdWx0LCBvcHRpb25zOiBBdWRpdE9wdGlvbnMpIHtcbiAgaWYgKG9wdGlvbnMuanNvbikge1xuICAgIGNvbnNvbGUubG9nKEpTT04uc3RyaW5naWZ5KHJlc3VsdCwgbnVsbCwgMikpXG4gICAgcmV0dXJuXG4gIH1cblxuICAvLyBIZWFkZXJcbiAgY29uc29sZS5sb2coJycpXG4gIGNvbnNvbGUubG9nKGAke2MuYm9sZH3ilZTilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZcke2MucmVzZXR9YClcbiAgY29uc29sZS5sb2coYCR7Yy5ib2xkfeKVkSR7Yy5yZXNldH0gICAgICAgICAgICR7Yy5jeWFufUdhbGxvcCBDYW5vbiR7Yy5yZXNldH0gJHtjLmRpbX12JHtyZXN1bHQudmVyc2lvbn0ke2MucmVzZXR9ICR7Yy5ib2xkfUNvbXBsaWFuY2UgUmVwb3J0JHtjLnJlc2V0fSAgICAgICAgICAgJHtjLmJvbGR94pWRJHtjLnJlc2V0fWApXG4gIGNvbnNvbGUubG9nKGAke2MuYm9sZH3ilZrilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZ0ke2MucmVzZXR9YClcbiAgY29uc29sZS5sb2coJycpXG5cbiAgaWYgKHJlc3VsdC52aW9sYXRpb25zLmxlbmd0aCA9PT0gMCkge1xuICAgIGNvbnNvbGUubG9nKGAgICR7Yy5ncmVlbn3inJMke2MucmVzZXR9ICR7Yy5ib2xkfUFsbCBmaWxlcyBwYXNzIENhbm9uIGNvbXBsaWFuY2UgY2hlY2tzJHtjLnJlc2V0fWApXG4gICAgY29uc29sZS5sb2coYCAgJHtjLmRpbX1QYXRoOiAke3Jlc3VsdC5wYXRofSR7Yy5yZXNldH1gKVxuICAgIGNvbnNvbGUubG9nKCcnKVxuICAgIHJldHVyblxuICB9XG5cbiAgLy8gU3VtbWFyeVxuICBjb25zdCBmaWxlc1dpdGhWaW9sYXRpb25zID0gbmV3IFNldChyZXN1bHQudmlvbGF0aW9ucy5tYXAodiA9PiB2LmZpbGUpKS5zaXplXG4gIGNvbnNvbGUubG9nKGAgICR7Yy5yZWR94pyXJHtjLnJlc2V0fSAke2MuYm9sZH0ke3Jlc3VsdC52aW9sYXRpb25zLmxlbmd0aH0gdmlvbGF0aW9uJHtyZXN1bHQudmlvbGF0aW9ucy5sZW5ndGggPT09IDEgPyAnJyA6ICdzJ30ke2MucmVzZXR9IGluICR7ZmlsZXNXaXRoVmlvbGF0aW9uc30gZmlsZSR7ZmlsZXNXaXRoVmlvbGF0aW9ucyA9PT0gMSA/ICcnIDogJ3MnfWApXG4gIGNvbnNvbGUubG9nKGAgICR7Yy5kaW19UGF0aDogJHtyZXN1bHQucGF0aH0ke2MucmVzZXR9YClcbiAgY29uc29sZS5sb2coJycpXG5cbiAgLy8gVmlvbGF0aW9ucyBieSBwYXR0ZXJuXG4gIGNvbnNvbGUubG9nKGAke2MuYm9sZH0gIFZpb2xhdGlvbnMgYnkgUGF0dGVybjoke2MucmVzZXR9YClcbiAgZm9yIChjb25zdCBbcGF0dGVybklkLCBjb3VudF0gb2YgT2JqZWN0LmVudHJpZXMocmVzdWx0LnN1bW1hcnkuYnlQYXR0ZXJuKS5zb3J0KCkpIHtcbiAgICBjb25zdCBwYXR0ZXJuID0gZ2V0UGF0dGVybihwYXR0ZXJuSWQpXG4gICAgY29uc3QgdGl0bGUgPSBwYXR0ZXJuPy50aXRsZSB8fCAnT3RoZXInXG4gICAgY29uc29sZS5sb2coYCAgICAke2MueWVsbG93fSR7cGF0dGVybklkfSR7Yy5yZXNldH0gJHt0aXRsZX06ICR7Yy5ib2xkfSR7Y291bnR9JHtjLnJlc2V0fWApXG4gIH1cbiAgY29uc29sZS5sb2coJycpXG5cbiAgLy8gRGV0YWlsZWQgdmlvbGF0aW9ucyBieSBmaWxlXG4gIGNvbnNvbGUubG9nKGAke2MuYm9sZH0gIERldGFpbHM6JHtjLnJlc2V0fWApXG4gIGNvbnNvbGUubG9nKCcnKVxuXG4gIGNvbnN0IGJ5RmlsZSA9IGdyb3VwQnlGaWxlKHJlc3VsdC52aW9sYXRpb25zKVxuICBmb3IgKGNvbnN0IFtmaWxlLCB2aW9sYXRpb25zXSBvZiBieUZpbGUpIHtcbiAgICAvLyBTaG9ydGVuIGZpbGUgcGF0aCBmb3IgZGlzcGxheVxuICAgIGNvbnN0IHNob3J0UGF0aCA9IGZpbGUucmVwbGFjZShwcm9jZXNzLmN3ZCgpICsgJy8nLCAnJylcbiAgICBjb25zb2xlLmxvZyhgICAke2MuY3lhbn0ke3Nob3J0UGF0aH0ke2MucmVzZXR9YClcbiAgICBcbiAgICBmb3IgKGNvbnN0IHYgb2YgdmlvbGF0aW9ucykge1xuICAgICAgY29uc3QgcGF0dGVybkxhYmVsID0gdi5jYW5vblBhdHRlcm4gXG4gICAgICAgID8gYCR7Yy55ZWxsb3d9WyR7di5jYW5vblBhdHRlcm59XSR7Yy5yZXNldH1gIFxuICAgICAgICA6IGAke2MuZGltfVstLS1dJHtjLnJlc2V0fWBcbiAgICAgIGNvbnN0IGxvY2F0aW9uID0gYCR7Yy5kaW19JHt2LmxpbmV9OiR7di5jb2x1bW59JHtjLnJlc2V0fWBcbiAgICAgIFxuICAgICAgLy8gQ2xlYW4gdXAgbWVzc2FnZSAocmVtb3ZlIFtDYW5vbiBYWFhdIHByZWZpeCBzaW5jZSB3ZSBzaG93IGl0IHNlcGFyYXRlbHkpXG4gICAgICBjb25zdCBjbGVhbk1lc3NhZ2UgPSB2Lm1lc3NhZ2UucmVwbGFjZSgvXFxbQ2Fub24gXFxkezN9XFxdXFxzKi8sICcnKVxuICAgICAgXG4gICAgICBjb25zb2xlLmxvZyhgICAgICR7bG9jYXRpb259ICR7cGF0dGVybkxhYmVsfSAke2NsZWFuTWVzc2FnZX1gKVxuICAgIH1cbiAgICBjb25zb2xlLmxvZygnJylcbiAgfVxuXG4gIC8vIEZvb3RlclxuICBjb25zb2xlLmxvZyhgJHtjLmRpbX0gIOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgCR7Yy5yZXNldH1gKVxuICBjb25zb2xlLmxvZyhgICAke2MuZGltfVJ1biB3aXRoIC0tZml4IHRvIGF1dG8tZml4IHdoZXJlIHBvc3NpYmxlJHtjLnJlc2V0fWApXG4gIGNvbnNvbGUubG9nKGAgICR7Yy5kaW19U2VlOiBodHRwczovL2dpdGh1Yi5jb20vZ2FsbG9wLXNvZnR3YXJlL2Nhbm9uJHtjLnJlc2V0fWApXG4gIGNvbnNvbGUubG9nKCcnKVxufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gYXVkaXQocGF0aDogc3RyaW5nLCBvcHRpb25zOiBBdWRpdE9wdGlvbnMpOiBQcm9taXNlPHZvaWQ+IHtcbiAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICBjb25zdCBhcmdzID0gW1xuICAgICAgJ2VzbGludCcsXG4gICAgICBwYXRoLFxuICAgICAgJy0tZm9ybWF0JywgJ3N0eWxpc2gnLFxuICAgIF1cblxuICAgIGlmIChvcHRpb25zLmZpeCkge1xuICAgICAgYXJncy5wdXNoKCctLWZpeCcpXG4gICAgfVxuXG4gICAgY29uc3QgZXNsaW50ID0gc3Bhd24oJ25weCcsIGFyZ3MsIHtcbiAgICAgIGN3ZDogcHJvY2Vzcy5jd2QoKSxcbiAgICAgIHN0ZGlvOiBbJ2luaGVyaXQnLCAncGlwZScsICdwaXBlJ10sXG4gICAgICBzaGVsbDogdHJ1ZSxcbiAgICB9KVxuXG4gICAgbGV0IHN0ZG91dCA9ICcnXG4gICAgbGV0IHN0ZGVyciA9ICcnXG5cbiAgICBlc2xpbnQuc3Rkb3V0Py5vbignZGF0YScsIChkYXRhKSA9PiB7XG4gICAgICBzdGRvdXQgKz0gZGF0YS50b1N0cmluZygpXG4gICAgfSlcblxuICAgIGVzbGludC5zdGRlcnI/Lm9uKCdkYXRhJywgKGRhdGEpID0+IHtcbiAgICAgIHN0ZGVyciArPSBkYXRhLnRvU3RyaW5nKClcbiAgICB9KVxuXG4gICAgZXNsaW50Lm9uKCdjbG9zZScsIChjb2RlKSA9PiB7XG4gICAgICBjb25zdCB2aW9sYXRpb25zID0gZXh0cmFjdFZpb2xhdGlvbnMoc3Rkb3V0KVxuICAgICAgXG4gICAgICBjb25zdCByZXN1bHQ6IEF1ZGl0UmVzdWx0ID0ge1xuICAgICAgICB2ZXJzaW9uLFxuICAgICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcbiAgICAgICAgcGF0aCxcbiAgICAgICAgdG90YWxGaWxlczogMCwgLy8gRVNMaW50IHN0eWxpc2ggZm9ybWF0IGRvZXNuJ3QgZ2l2ZSB1cyB0aGlzIGVhc2lseVxuICAgICAgICB2aW9sYXRpb25zLFxuICAgICAgICBzdW1tYXJ5OiB7XG4gICAgICAgICAgdG90YWw6IHZpb2xhdGlvbnMubGVuZ3RoLFxuICAgICAgICAgIGJ5UGF0dGVybjogY291bnRCeVBhdHRlcm4odmlvbGF0aW9ucyksXG4gICAgICAgIH0sXG4gICAgICB9XG5cbiAgICAgIHByaW50UmVwb3J0KHJlc3VsdCwgb3B0aW9ucylcblxuICAgICAgaWYgKG9wdGlvbnMuc3RyaWN0ICYmIHZpb2xhdGlvbnMubGVuZ3RoID4gMCkge1xuICAgICAgICBwcm9jZXNzLmV4aXQoMSlcbiAgICAgIH1cblxuICAgICAgcmVzb2x2ZSgpXG4gICAgfSlcblxuICAgIGVzbGludC5vbignZXJyb3InLCAoZXJyb3IpID0+IHtcbiAgICAgIHJlamVjdChlcnJvcilcbiAgICB9KVxuICB9KVxufVxuIl19